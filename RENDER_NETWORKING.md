# ğŸ”— Inter-Service Communication on Render

## How Services Talk to Each Other

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User/Browser                                        â”‚
â”‚  https://securebox-api-gateway.onrender.com         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ (Public Internet)
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  API Gateway (Port 5000)     â”‚ â—„â”€â”€ Public URL
    â”‚  securebox-api-gateway       â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â”‚ (Internal)       â”‚ (Internal)
       â”‚                  â”‚
       â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Encryption   â”‚   â”‚  Storage     â”‚
â”‚ Service      â”‚   â”‚  Service     â”‚
â”‚ (Port 8001)  â”‚   â”‚  (Port 8002) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â”‚                  â”‚
       â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     Redis (Port 6379)        â”‚
    â”‚   PostgreSQL (Port 5432)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Render's Networking Model

### 1. Public URLs (External Access)
**Format:** `https://service-name.onrender.com`

- Used by: Users, external clients
- Example: `https://securebox-api-gateway.onrender.com`
- Features: HTTPS, custom domains, public internet
- Cost: Free bandwidth included

### 2. Private Network (Service-to-Service)
**Format:** `http://service-name:port`

- Used by: Services talking to each other
- Example: `http://securebox-encryption:8001`
- Features: 
  - âœ… **No internet routing** (faster, free)
  - âœ… **Low latency** (<1ms)
  - âœ… **No bandwidth charges**
  - âœ… **More secure** (not exposed to internet)

---

## ğŸ”§ Environment Variables Configuration

### API Gateway Service

**Your code uses:**
```python
ENCRYPTION_SERVICE_URL = os.getenv('ENCRYPTION_SERVICE_URL', 'http://localhost:8001')
STORAGE_SERVICE_URL = os.getenv('STORAGE_SERVICE_URL', 'http://localhost:8002')
```

**On Render, set to:**
```bash
ENCRYPTION_SERVICE_URL=http://securebox-encryption:8001
STORAGE_SERVICE_URL=http://securebox-storage:8002
```

**How it works:**
- `securebox-encryption` = Render's internal DNS name for that service
- `:8001` = The port your encryption service listens on
- Services in same Render account can resolve these names automatically

---

### Encryption Service

**Your code uses:**
```python
redis_client = redis.Redis(
    host=os.getenv('REDIS_HOST', 'localhost'),
    port=int(os.getenv('REDIS_PORT', 6379))
)
```

**On Render, set to:**
```bash
REDIS_HOST=securebox-redis
REDIS_PORT=6379
```

**Note:** Render provides internal Redis URLs, use the hostname from Render dashboard

---

### Storage Service

**Your code uses:**
```python
POSTGRES_HOST = os.getenv('POSTGRES_HOST', 'localhost')
POSTGRES_PORT = os.getenv('POSTGRES_PORT', 5432)
REDIS_HOST = os.getenv('REDIS_HOST', 'localhost')
```

**On Render, set to:**
```bash
# PostgreSQL (Render provides these automatically)
POSTGRES_HOST=<from-render-dashboard>
POSTGRES_PORT=5432
POSTGRES_DB=securebox
POSTGRES_USER=<from-render>
POSTGRES_PASSWORD=<from-render>

# Redis
REDIS_HOST=securebox-redis
REDIS_PORT=6379

# Storage (S3)
MINIO_ENDPOINT=s3.amazonaws.com
MINIO_ACCESS_KEY=<your-aws-key>
MINIO_SECRET_KEY=<your-aws-secret>
```

---

## ğŸ“‹ Complete Environment Variables by Service

### 1. API Gateway
```bash
# Internal service URLs (use private network)
ENCRYPTION_SERVICE_URL=http://securebox-encryption:8001
STORAGE_SERVICE_URL=http://securebox-storage:8002

# Redis
REDIS_HOST=securebox-redis
REDIS_PORT=6379

# Security
SECRET_KEY=<auto-generated-by-render>
JWT_SECRET_KEY=<auto-generated-by-render>

# Server config
API_GATEWAY_HOST=0.0.0.0
API_GATEWAY_PORT=5000
```

### 2. Encryption Service
```bash
# Redis
REDIS_HOST=securebox-redis
REDIS_PORT=6379

# Encryption config
ENCRYPTION_KEY_SIZE=32
RSA_KEY_SIZE=2048

# Server config
ENCRYPTION_SERVICE_HOST=0.0.0.0
ENCRYPTION_SERVICE_PORT=8001
```

### 3. Storage Service
```bash
# PostgreSQL (from Render dashboard)
POSTGRES_HOST=dpg-xxxxx.oregon-postgres.render.com
POSTGRES_PORT=5432
POSTGRES_DB=securebox
POSTGRES_USER=securebox_user
POSTGRES_PASSWORD=<from-render>

# Redis
REDIS_HOST=securebox-redis
REDIS_PORT=6379

# S3 Storage
MINIO_ENDPOINT=s3.amazonaws.com
MINIO_ACCESS_KEY=<your-aws-key>
MINIO_SECRET_KEY=<your-aws-secret>
MINIO_BUCKET_NAME=securebox-files
MINIO_SECURE=true

# Server config
STORAGE_SERVICE_HOST=0.0.0.0
STORAGE_SERVICE_PORT=8002
```

### 4. Background Worker & Celery Beat
```bash
# Celery (Redis as broker)
CELERY_BROKER_URL=redis://securebox-redis:6379/1
CELERY_RESULT_BACKEND=redis://securebox-redis:6379/2

# Redis
REDIS_HOST=securebox-redis
REDIS_PORT=6379

# PostgreSQL (same as storage service)
POSTGRES_HOST=dpg-xxxxx.oregon-postgres.render.com
POSTGRES_PORT=5432
POSTGRES_DB=securebox
POSTGRES_USER=securebox_user
POSTGRES_PASSWORD=<from-render>

# S3 Storage
MINIO_ENDPOINT=s3.amazonaws.com
MINIO_ACCESS_KEY=<your-aws-key>
MINIO_SECRET_KEY=<your-aws-secret>
MINIO_BUCKET_NAME=securebox-files
```

---

## ğŸ¯ How Render Resolves Service Names

### Internal DNS Resolution

When you deploy to Render:

1. **Service Name â†’ Internal IP**
   ```bash
   securebox-encryption â†’ 10.x.x.x:8001
   securebox-storage â†’ 10.x.x.x:8002
   securebox-redis â†’ 10.x.x.x:6379
   ```

2. **Automatic Discovery**
   - All services in same Render account see each other
   - No manual IP configuration needed
   - Survives service restarts (IPs may change)

3. **Port Mapping**
   - Your app listens on the port defined in code (5000, 8001, 8002)
   - Render maps these internally
   - Only API Gateway needs public port (443 for HTTPS)

---

## ğŸ” Debugging Connection Issues

### Check if services can reach each other:

**From Render Shell (in any service):**
```bash
# Test if encryption service is reachable
curl http://securebox-encryption:8001/health

# Test Redis
redis-cli -h securebox-redis ping

# Test PostgreSQL
psql -h <postgres-host> -U <user> -d securebox -c "SELECT 1;"
```

### Common Issues:

**âŒ Connection refused**
- Service not running yet (check logs)
- Port mismatch (verify Dockerfile EXPOSE matches code)
- Service name typo

**âŒ Name resolution failed**
- Using wrong service name
- Services in different Render accounts
- Need to use full internal URL from dashboard

**âœ… Solution:**
- Use exact service names from Render dashboard
- Check "Internal URLs" section in each service
- Format: `http://service-name:port`

---

## ğŸ’¡ Best Practices

### 1. Always Use Internal URLs for Service-to-Service
```python
# âœ… Good (fast, free, secure)
ENCRYPTION_SERVICE_URL = 'http://securebox-encryption:8001'

# âŒ Bad (slow, costs bandwidth, insecure)
ENCRYPTION_SERVICE_URL = 'https://securebox-encryption.onrender.com'
```

### 2. Port Configuration
```python
# Each service must bind to 0.0.0.0 (not localhost!)
app.run(host='0.0.0.0', port=8001)
```

### 3. Health Checks
```python
@app.route('/health')
def health():
    return {'status': 'healthy'}, 200
```

### 4. Environment Variable Fallbacks
```python
# Good practice: fallback for local dev
ENCRYPTION_SERVICE_URL = os.getenv(
    'ENCRYPTION_SERVICE_URL',
    'http://localhost:8001'  # for local Docker
)
```

---

## ğŸš€ Deployment Checklist

- [ ] All services listen on `0.0.0.0` (not `localhost`)
- [ ] Ports match between code and environment variables
- [ ] Service names match Render service names exactly
- [ ] Internal URLs use `http://` not `https://`
- [ ] Database credentials from Render dashboard
- [ ] Redis hostname from Render dashboard
- [ ] Health check endpoints work
- [ ] Environment variables set for each service

---

## ğŸ“Š Performance

**Internal Network (Service-to-Service):**
- Latency: <1ms
- Bandwidth: Unlimited, free
- Throughput: ~10Gbps

**Public Internet:**
- Latency: 50-200ms
- Bandwidth: Charged after free tier
- Throughput: ~1Gbps

**Recommendation:** Always use internal network for service communication!

---

## ğŸ” Security

### Internal Network Benefits:
- âœ… Not exposed to internet
- âœ… No need for authentication between services (trusted zone)
- âœ… Encrypted within Render's infrastructure
- âœ… Isolated from other Render customers

### Public Endpoints:
- Only API Gateway needs public access
- All other services stay private
- Users never directly access encryption/storage services

---

## ğŸ“ Summary

**Key Takeaways:**

1. **Service URLs**: `http://service-name:port`
2. **Database/Redis**: Use hostnames from Render dashboard
3. **Public access**: Only API Gateway (automatically gets HTTPS)
4. **Private access**: All other services (HTTP is fine)
5. **No manual networking**: Render handles everything
6. **Cost**: Internal communication is FREE

Your services will automatically discover and connect to each other using these environment variables! ğŸ‰
